name: Python GitOps CI/CD (Agro App)
permissions:
  contents: write
  security-events: write

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Select environment"
        required: true
        type: choice
        options: [ dev, staging, prod ]
        default: dev

      deploy:
        description: "Deploy after build?"
        required: true
        type: boolean
        default: true

  push:
    branches: [ "main" ]

jobs:
  # -----------------------------------------------------------
  # 1️⃣ BUILD + TEST + DOCKER BUILD & PUSH
  # -----------------------------------------------------------
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ---- Python ----
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run tests
        run: |
          echo "No tests yet"
          # pytest

      # ---- Docker Hub login ----
      - name: Login to Docker Hub
        run: |
          echo "${{ secrets.DOCKER_HUB_PASSWORD }}" | docker login \
            -u "${{ secrets.DOCKER_HUB_USERNAME }}" --password-stdin

      # ---- Build Docker image ----
      - name: Build Docker image
        run: |
          docker build -t iscomarcuz/agro-app:${{ github.sha }} .

      # ---- Push Docker image ----
      - name: Push Docker image
        run: |
          docker push iscomarcuz/agro-app:${{ github.sha }}

      # -----------------------------------------------------------
      #  GitOps — update Helm values for selected environment
      # -----------------------------------------------------------
      - name: Update Helm image tag
        if: ${{ github.event.inputs.deploy == 'true' || github.ref == 'refs/heads/main' }}
        run: |
          ENV="${{ github.event.inputs.environment }}"
          if [ -z "$ENV" ]; then
            ENV="dev"
          fi

          FILE="gitops-repo/charts/agro-api/values-$ENV.yaml"

          echo "Using environment: $ENV"
          echo "Updating: $FILE"

          sed -i "s|tag:.*|tag: \"${{ github.sha }}\"|g" "$FILE"

      - name: Commit GitOps changes
        if: ${{ github.event.inputs.deploy == 'true' || github.ref == 'refs/heads/main' }}
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add gitops-repo/charts/agro-api
          git commit -m "GitOps: update image tag to ${{ github.sha }}"
          git push
  

  # -----------------------------------------------------------
  # 2️⃣ TRIVY SECURITY SCAN
  # -----------------------------------------------------------
  trivy-scan:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build image for scan
        run: |
          docker build -t agro-app:${{ github.sha }} .

      - name: Trivy Scan (table)
        uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: image
          image-ref: agro-app:${{ github.sha }}
          severity: CRITICAL,HIGH
          ignore-unfixed: true
          format: table

      - name: Trivy Scan (SARIF)
        uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: image
          image-ref: agro-app:${{ github.sha }}
          format: sarif
          output: trivy-results.sarif

      - name: Upload SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-results.sarif
